## 用户认证

### 用户注册
1. 注册流程
   - 用户提供以下信息进行注册：
     - 用户名（必填，唯一）
     - 密码（必填）
     - 姓名（必填）
     - 邮箱（可选，唯一）
     - 电话（可选）
     - 地址（可选）
   - 系统验证：
     - 检查用户名是否已存在
     - 检查邮箱是否已被使用
     - 密码加密存储
   - 注册成功：
     - 自动设置注册时间
     - 创建时间
     - 更新时间
     - 生成用户ID

2. 注册接口
   - 请求方式：POST
   - 接口路径：/api/auth/register
   - 请求体示例：
     ```json
     {
       "username": "user123",
       "password": "password123",
       "name": "张三",
       "email": "user123@example.com",
       "phone": "13800138000",
       "address": "北京市朝阳区"
     }
     ```

### 用户登录
1. 登录流程
   - 用户提供：
     - 用户名
     - 密码
   - 系统验证：
     - 检查用户名是否存在
     - 验证密码是否正确
   - 登录成功：
     - 返回用户基本信息

2. 登录接口
   - 请求方式：POST
   - 接口路径：/api/auth/login
   - 请求体示例：
     ```json
     {
       "username": "user123",
       "password": "password123"
     }
     ```

### 维修人员登录
1. 登录流程
   - 维修人员提供：
     - 用户名
     - 密码
   - 系统验证：
     - 检查用户名是否存在
     - 验证密码是否正确
     - 验证用户类型是否为维修人员
   - 登录成功：
     - 返回维修人员基本信息

2. 登录接口
   - 请求方式：POST
   - 接口路径：/api/auth/staff/login
   - 请求体示例：
     ```json
     {
       "username": "staff123",
       "password": "password123"
     }
     ```

### 管理员登录
1. 登录流程
   - 管理员提供：
     - 用户名
     - 密码
   - 系统验证：
     - 检查用户名是否存在
     - 验证密码是否正确
     - 验证用户类型是否为管理员
   - 登录成功：
     - 返回管理员基本信息

2. 登录接口
   - 请求方式：POST
   - 接口路径：/api/auth/admin/login
   - 请求体示例：
     ```json
     {
       "username": "admin",
       "password": "admin123"
     }
     ```

## 系统架构与组件通信

### 系统总体架构

车辆维修管理系统采用分层架构设计，主要包含以下几个主要部分：

1. **表示层（GUI模块）**：提供用户界面，处理用户交互
2. **业务逻辑层**：实现核心业务逻辑，处理数据验证和业务规则
3. **数据访问层**：负责与数据库交互，实现数据持久化
4. **REST API层**：提供HTTP接口，支持外部系统集成

```
┌─────────────────────────────────────┐
│             表示层 (GUI)            │
│  ┌─────────────┐  ┌──────────────┐  │
│  │ LoginFrame  │  │ UserMainFrame│  │
│  └─────────────┘  └──────────────┘  │
│  ┌─────────────┐  ┌──────────────┐  │
│  │StaffMainFrame│ │AdminMainFrame│  │
│  └─────────────┘  └──────────────┘  │
└───────────────┬─────────────────────┘
                │
                ▼
┌─────────────────────────────────────┐
│            服务代理层               │
│  ┌─────────────────────────────┐    │
│  │       BackendService        │    │
│  └─────────────────────────────┘    │
└───────────────┬─────────────────────┘
                │
                ▼
┌─────────────────────────────────────┐
│            业务逻辑层               │
│  ┌───────────┐ ┌────────────────┐   │
│  │AuthService│ │VehicleService  │   │
│  └───────────┘ └────────────────┘   │
│  ┌────────────────────────────────┐ │
│  │    RepairRequestService        │ │
│  └────────────────────────────────┘ │
└───────────────┬─────────────────────┘
                │
                ▼
┌─────────────────────────────────────┐
│            数据访问层               │
│  ┌─────────┐ ┌────────┐ ┌────────┐  │
│  │UserRepo │ │VehicleR│ │RepairR │  │
│  └─────────┘ └────────┘ └────────┘  │
└───────────────┬─────────────────────┘
                │
                ▼
┌─────────────────────────────────────┐
│              数据库                 │
└─────────────────────────────────────┘
```

### GUI与后端业务逻辑的连接架构

当前项目中，GUI界面与后端业务逻辑的连接采用**内嵌集成方式**。这意味着GUI模块直接内嵌了业务逻辑和数据访问组件，通过依赖注入方式实现通信。具体连接方式如下：

1. **依赖注入方式**：
   - 使用Spring框架的依赖注入（DI）将业务服务注入到GUI组件中
   - GUI组件通过`@Autowired`注解引用业务服务

2. **服务代理层**：
   - `BackendService`类作为GUI和后端业务逻辑之间的桥梁
   - 它封装了对各种业务服务的调用，为GUI提供统一接口

3. **生命周期管理**：
   - 所有组件由Spring容器统一管理生命周期
   - GUI启动时，Spring容器自动初始化并注入所有必要的服务

### 数据流程说明

以车辆管理功能为例，数据流程如下：

1. **用户添加车辆**：
   - 用户在GUI中点击"添加车辆"按钮 → `VehicleDialog`显示
   - 用户输入车辆信息并提交 → `VehicleDialog.handleSave()`方法被调用
   - `VehicleDialog`调用`BackendService.addVehicle()`方法
   - `BackendService`调用`VehicleService.save()`方法
   - `VehicleService`使用`VehicleRepository`将数据保存到数据库
   - 结果通过调用链返回到GUI界面，显示成功或失败消息

2. **查看车辆列表**：
   - GUI界面初始化时调用`BackendService.getUserVehicles()`
   - `BackendService`调用`VehicleService.findByUserId()`
   - `VehicleService`使用`VehicleRepository`查询数据库
   - 返回车辆列表，GUI展示结果

### 依赖关系

为确保GUI模块能正常访问业务逻辑，需要满足以下依赖条件：

1. **类路径依赖**：
   - GUI模块需要在类路径中包含业务逻辑和数据访问层的所有相关类
   - 这可通过直接将相关类复制到GUI模块，或添加对后端模块的Maven依赖实现

2. **组件扫描配置**：
   - 在`App`类中配置了组件扫描范围，确保能发现并初始化所有必要的Spring组件
   ```java
   @ComponentScan(basePackages = {
       "com.car", 
       "com.car.service",
       "com.car.view",
       "com.carpj.service", 
       "com.carpj.service.impl", 
       "com.carpj.controller", 
       "com.carpj.repository",
       "com.carpj.config"
   })
   ```

3. **实体类扫描**：
   - 使用`@EntityScan`注解配置JPA实体扫描
   ```java
   @EntityScan(basePackages = {"com.carpj.model"})
   ```

4. **仓库接口扫描**：
   - 使用`@EnableJpaRepositories`注解配置数据仓库扫描
   ```java
   @EnableJpaRepositories(basePackages = {"com.carpj.repository"})
   ```

### 组件打包和部署

当前系统采用一体化部署方式，即将GUI和后端业务逻辑打包为单个可执行JAR文件。这种方式简化了部署，但需确保所有必要的类都包含在最终的JAR文件中。

在生产环境中，可考虑将系统拆分为前端和后端两个独立部署的组件，通过REST API进行通信，以提高系统的可扩展性和维护性。

## 安全特性
1. 密码加密
   - 使用BCrypt加密算法
   - 自动加盐处理

2. JWT令牌
   - 包含用户ID
   - 包含用户类型
   - 设置过期时间
   - 签名验证

3. 权限控制
   - 基于角色的访问控制
   - 接口级别的权限验证
   - 数据级别的权限控制

## 错误处理
1. 注册错误
   - 用户名已存在
   - 邮箱已被使用
   - 必填字段缺失

2. 登录错误
   - 用户名不存在
   - 密码错误
   - 用户类型不匹配

## 数据库表结构
系统使用以下主要表进行用户认证：
- User：存储用户信息
- MaintenanceStaff：存储维修人员信息
- Administrator：存储管理员信息

# 车辆维修管理系统数据库设计

本数据库设计旨在支持车辆维修管理系统的全面功能需求，包括用户管理、车辆信息、维修工单处理、材料库存、财务管理等核心业务流程。

## 数据库实体关系图

ER图文件: `ER_diagram.puml`

使用PlantUML格式设计，可通过在线工具如 [PlantUML Online Server](https://www.plantuml.com/plantuml/) 查看或导出为图片。

## 数据库表结构

数据库包含以下主要表:

1. **User** - 存储客户信息
2. **Vehicle** - 存储车辆信息，与用户关联
3. **MaintenanceStaff** - 存储维修人员信息
4. **Administrator** - 存储系统管理员信息
5. **WorkOrder** - 存储维修工单信息
6. **RepairRecord** - 存储维修记录详情
7. **Material** - 存储维修材料/零件信息
8. **MaterialUsage** - 记录材料使用情况
9. **Feedback** - 存储用户反馈
10. **PaymentRecord** - 存储付款记录
11. **StaffPayment** - 存储维修人员工资支付记录
12. **AuditLog** - 记录系统操作日志

## 数据一致性维护

数据库实现了以下触发器来确保数据一致性:

1. **update_workorder_costs** - 当添加材料使用记录时，自动更新工单的材料成本和总成本
2. **update_labor_costs** - 当更新维修记录时，自动更新工单的工时费和总成本
3. **update_material_stock** - 当使用材料时，自动减少库存数量

## 数据视图

为便于常见查询需求，数据库创建了以下视图:

1. **UserVehicleHistory** - 用户车辆维修历史记录
2. **StaffPerformance** - 维修人员绩效统计
3. **MaterialConsumptionReport** - 材料消耗报告
4. **FinancialSummary** - 财务收支汇总

## 系统工作流程

1. 用户注册并提交维修申请
2. 系统生成工单并分配给合适的维修人员
3. 维修人员接单并记录维修过程与材料使用情况
4. 系统自动计算维修费用(工时费+材料费)
5. 用户确认并支付费用
6. 管理员监控整个流程并进行数据维护

## 数据统计与分析

数据库设计支持以下统计与分析需求:

- 车型维修次数与费用统计
- 故障类型分析
- 季度成本分析
- 负面反馈筛选
- 工种任务占比分析
- 未完成工单统计
- 财务收支分析

## 实现说明

数据库SQL脚本文件: `create_tables.sql`

该脚本包含所有表的创建语句、触发器定义以及视图创建，可直接用于数据库初始化。 